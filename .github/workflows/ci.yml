name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  checks: write
  pull-requests: write

jobs:
  backend-ci:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    steps:
      # Checkout
      - name: Clone the repo
        uses: actions/checkout@v6

      # Inlined dotnet-setup
      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: "**/packages.lock.json"

      - name: Restore NuGet packages
        run: dotnet restore --locked-mode

      # Formatting
      - name: Restore tools
        run: dotnet tool restore

      - name: Check formatting with CSharpier
        run: dotnet csharpier check .

      # Build & Test
      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Preload docker images for tests
        run: docker pull postgres:18.2

      - name: Run Tests
        run: >-
          dotnet test
          --no-restore
          --no-build
          --configuration Release
          --logger "console;verbosity=normal"
          --logger "trx;LogFileName=test-results/results.trx"
          --logger "GitHubActions;summary.includePassedTests=true;summary.includeSkippedTests=true"
          --blame
          --blame-hang-timeout 7m
          --blame-crash
          --results-directory test-results
          --collect "XPlat Code Coverage" -- RunConfiguration.CollectSourceInformation=true

      # Coverage reporting
      - name: Generate Coverage Report
        uses: danielpalme/ReportGenerator-GitHub-Action@ee0ae774f6d3afedcbd1683c1ab21b83670bdf8e # 5.5.1
        with:
          reports: "test-results/**/*.cobertura.xml"
          targetdir: coverage-report
          reporttypes: "HtmlSummary;Cobertura;MarkdownSummary;MarkdownSummaryGithub"
          verbosity: "Info"
          title: "Code Coverage"
          tag: "${{ github.run_number }}_${{ github.run_id }}"

      - name: Add Coverage to Step Summary
        run: cat coverage-report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          header: dotnet-coverage
          path: coverage-report/SummaryGithub.md

      # Artifacts
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-test-results
          path: test-results/**

      - name: Publish Migrator
        run: >-
          dotnet publish
          ./src/HackathonManager.Migrator/HackathonManager.Migrator.csproj
          --no-build
          --configuration Release
          --output ./artifacts/HackathonManager.Migrator

      - name: Publish App
        run: >-
          dotnet publish
          ./src/HackathonManager/HackathonManager.csproj
          --no-build
          --configuration Release
          --output ./artifacts/HackathonManager

      - name: Upload publish artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-build-artifacts
          path: ./artifacts/**

  backend-sql-lint:
    runs-on: "ubuntu-latest"
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run SqlFluff
        run: npm run sqlfluff lint -- --format github-annotation --write-output /sql/sql-lint.json

      - name: Annotate Pull Request
        if: github.event_name == 'pull_request'
        uses: yuzutech/annotations-action@d6062d2ca2402a84f058b9485eee8b59d58a98d5 # v0.5.0
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          title: SQL Lint Results
          input: ./sql-lint.json

  frontend-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run spa lint:check

      - name: Type check
        run: npm run spa check

      - name: Run tests with coverage
        run: npm run spa test:coverage

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: spa-test-results
          path: |
            ./src/hackathon-spa/test-results/
            ./src/hackathon-spa/coverage/

      - name: Build
        run: npm run spa build -- --outDir="${{ github.workspace }}/artifacts/hackathon-spa"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: spa-build-artifacts
          path: ./artifacts/**

      - name: Report coverage
        if: always() && github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@15b5b41bb7d36796d89f4bf482b09529c53f3446 # v2
        with:
          name: "SPA Coverage"
          vite-config-path: src/hackathon-spa/vite.config.ts
          json-summary-path: src/hackathon-spa/coverage/coverage-summary.json
          json-final-path: src/hackathon-spa/coverage/coverage-final.json
          file-coverage-mode: "changes"
