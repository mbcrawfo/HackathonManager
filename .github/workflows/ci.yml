name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  checks: write
  pull-requests: write

jobs:
  dotnet-ci:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    steps:
      # Checkout
      - name: Clone the repo
        uses: actions/checkout@v6

      # Inlined dotnet-setup
      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: "**/packages.lock.json"

      - name: Restore NuGet packages
        run: dotnet restore --locked-mode

      # Formatting
      - name: Restore tools
        run: dotnet tool restore

      - name: Check formatting with CSharpier
        run: dotnet csharpier check .

      # Build & Test
      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Preload docker images for tests
        run: docker pull postgres:18.2

      - name: Run Tests
        run: >-
          dotnet test
          --no-restore
          --no-build
          --configuration Release
          --logger "console;verbosity=normal"
          --logger "trx;LogFileName=test-results/results.trx"
          --logger "GitHubActions;summary.includePassedTests=true;summary.includeSkippedTests=true"
          --blame
          --blame-hang-timeout 7m
          --blame-crash
          --results-directory test-results
          --collect "XPlat Code Coverage" -- RunConfiguration.CollectSourceInformation=true

      # Coverage reporting
      - name: Generate Coverage Report
        uses: danielpalme/ReportGenerator-GitHub-Action@ee0ae774f6d3afedcbd1683c1ab21b83670bdf8e # 5.5.1
        with:
          reports: "test-results/**/*.cobertura.xml"
          targetdir: coverage-report
          reporttypes: "HtmlSummary;Cobertura;MarkdownSummary;MarkdownSummaryGithub"
          verbosity: "Info"
          title: "Code Coverage"
          tag: "${{ github.run_number }}_${{ github.run_id }}"

      - name: Add Coverage to Step Summary
        run: cat coverage-report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          header: dotnet-coverage
          path: coverage-report/SummaryGithub.md

      # Artifacts
      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-test-results
          path: test-results/**

      - name: Publish Migrator
        run: >-
          dotnet publish
          ./src/HackathonManager.Migrator/HackathonManager.Migrator.csproj
          --no-build
          --configuration Release
          --output ./artifacts/HackathonManager.Migrator

      - name: Publish App
        run: >-
          dotnet publish
          ./src/HackathonManager/HackathonManager.csproj
          --no-build
          --configuration Release
          --output ./artifacts/HackathonManager

      - name: Upload publish artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dotnet-build-artifacts
          path: ./artifacts/**

  node-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run check

      - name: Lint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Run unit tests with coverage
        run: npm run spa test:coverage

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: spa-test-results
          path: |
            ./src/hackathon-spa/test-results/
            ./src/hackathon-spa/coverage/

      - name: Build
        run: npm run spa build -- --outDir="${{ github.workspace }}/artifacts/hackathon-spa"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: spa-build-artifacts
          path: ./artifacts/**

      - name: Report coverage
        if: ${{ !cancelled() && github.event_name == 'pull_request' }}
        uses: davelosert/vitest-coverage-report-action@15b5b41bb7d36796d89f4bf482b09529c53f3446 # v2
        with:
          name: "SPA Coverage"
          vite-config-path: src/hackathon-spa/vite.config.ts
          json-summary-path: src/hackathon-spa/coverage/coverage-summary.json
          json-final-path: src/hackathon-spa/coverage/coverage-final.json
          file-coverage-mode: "changes"

  sql-lint:
    runs-on: "ubuntu-latest"
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Run SqlFluff
        run: npm run sqlfluff lint -- --format github-annotation-native

  container-build:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    needs: [dotnet-ci, node-ci, sql-lint]
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: hackathon-api
            dockerfile: docker/api.Dockerfile
          - name: hackathon-spa
            dockerfile: docker/spa.Dockerfile
          - name: hackathon-integrated
            dockerfile: docker/integrated.Dockerfile
        runner:
          - os: ubuntu-latest
            platform: linux/amd64
            arch: amd64
          - os: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    runs-on: ${{ matrix.runner.os }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          platforms: ${{ matrix.runner.platform }}
          outputs: type=image,"name=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}",push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.image.name }}-${{ matrix.runner.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image.name }}-${{ matrix.runner.arch }}

      - name: Export digest
        run: |
          mkdir -p "$RUNNER_TEMP/digests"
          digest="${{ steps.build.outputs.digest }}"
          touch "$RUNNER_TEMP/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digest-${{ matrix.image.name }}-${{ matrix.runner.arch }}
          path: ${{ runner.temp }}/digests/*

  container-merge:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: [container-build]
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        image: [hackathon-api, hackathon-spa, hackathon-integrated]
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download digests
        uses: actions/download-artifact@v6
        with:
          path: ${{ runner.temp }}/digests
          pattern: digest-${{ matrix.image }}-*
          merge-multiple: true

      - name: Create manifest list and push
        working-directory: ${{ runner.temp }}/digests
        run: >-
          docker buildx imagetools create
          --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ github.sha }}
          $(printf 'ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}@sha256:%s ' *)

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [dotnet-ci, node-ci, sql-lint, container-merge]
    if: ${{ !(failure() || cancelled()) }}
    timeout-minutes: 60
    permissions:
      contents: read
      packages: read
    steps:
      - name: Clone the repo
        uses: actions/checkout@v6

      - name: Set E2E_IMAGE
        if: needs.container-merge.result == 'success'
        run: echo "E2E_IMAGE=ghcr.io/${{ github.repository_owner }}/hackathon-integrated:${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Login to GHCR
        if: needs.container-merge.result == 'success'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull integrated image
        if: needs.container-merge.result == 'success'
        run: docker pull ${{ env.E2E_IMAGE }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx --workspace tests/e2e playwright install --with-deps

      - name: Run E2E tests
        run: npm run e2e:docker

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30
